(()=>{"use strict";const e=[{type:"email",pattern:/\b[A-Za-z0-9._%+\-]+@[A-Za-z0-9.\-]+\.[A-Za-z]{2,}\b/g,replacement:"[REDACTED_EMAIL]"},{type:"phone",pattern:/(\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g,replacement:"[REDACTED_PHONE]"},{type:"ssn",pattern:/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,replacement:"[REDACTED_SSN]"},{type:"credit_card",pattern:/\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|6(?:011|5[0-9]{2})[0-9]{12})\b/g,replacement:"[REDACTED_CREDIT_CARD]"},{type:"api_key",pattern:/\b(sk-[A-Za-z0-9]{20,}|AIza[0-9A-Za-z\-_]{35}|(?:ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9]{36}|xoxb-[0-9]+-[0-9]+-[A-Za-z0-9]+)\b/g,replacement:"[REDACTED_API_KEY]"}],t=[{type:"private_key",severity:"critical",pattern:/-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----[\s\S]{0,8192}?-----END (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----/g,replacement:"[REDACTED_PRIVATE_KEY]"},{type:"database_url",severity:"critical",pattern:/\b(postgres|postgresql|mysql|mongodb|redis|mongodb\+srv):\/\/[^\s"']{1,512}/gi,replacement:"[REDACTED_DATABASE_URL]"},{type:"aws_access_key",severity:"high",pattern:/\b(AKIA|AGPA|AROA|ASCA|ASIA)[A-Z0-9]{16}\b/g,replacement:"[REDACTED_AWS_KEY]"},{type:"openai_key",severity:"high",pattern:/\bsk-(?:proj-)?[A-Za-z0-9]{20,}\b/g,replacement:"[REDACTED_OPENAI_KEY]"},{type:"github_token",severity:"high",pattern:/\b(ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9]{36}\b/g,replacement:"[REDACTED_GITHUB_TOKEN]"},{type:"slack_token",severity:"high",pattern:/\bxox[baprs]-[0-9A-Za-z\-]{10,64}\b/g,replacement:"[REDACTED_SLACK_TOKEN]"},{type:"jwt",severity:"high",pattern:/\beyJ[A-Za-z0-9\-_]{1,512}\.[A-Za-z0-9\-_]{1,512}\.[A-Za-z0-9\-_]{1,512}\b/g,replacement:"[REDACTED_JWT]"},{type:"bearer_token",severity:"high",pattern:/\bBearer\s+[A-Za-z0-9\-._~+/]{20,256}\b/gi,replacement:"Bearer [REDACTED_TOKEN]"},{type:"env_secret",severity:"medium",pattern:/\b(DB_PASSWORD|API_KEY|SECRET_KEY|SECRET|PASSWORD|PASSWD|AUTH_TOKEN|ACCESS_TOKEN|PRIVATE_KEY)\s*=\s*["']?[A-Za-z0-9\-._~+/=]{8,256}["']?/gi,replacement:"[REDACTED_ENV_SECRET]"}],n={private_key:40,database_url:35,aws_access_key:30,jwt:25,bearer_token:25,slack_token:25,github_token:25,openai_key:25,env_secret:15};function o(e){return e<=20?"low":e<=50?"medium":e<=80?"high":"critical"}const r={block:3,mask:2,warn:1,allow:0};function a(e,t){const{condition:n}=e;if("detection_type"===n.type){const e=t.detections.filter(e=>!n.detectionType||e.type===n.detectionType).reduce((e,t)=>e+t.count,0);return void 0!==n.countGt?e>n.countGt:e>0}return"keyword"===n.type?!!n.keyword&&t.messageText.toLowerCase().includes(n.keyword.toLowerCase()):"risk_score"===n.type&&void 0!==n.riskScoreGt&&null!==t.riskScore&&t.riskScore.score>n.riskScoreGt}const s={enabled:!0,filters:["email","phone","ssn","credit_card","api_key"],policies:[]};class c{constructor(){this.siteName="ChatGPT"}getInputElement(){return document.querySelector("#prompt-textarea")??document.querySelector('[data-testid="send-message-textarea"]')}getSubmitButton(){return document.querySelector('[data-testid="send-button"]')??document.querySelector('button[aria-label*="send" i]')}getText(e){return e instanceof HTMLTextAreaElement?e.value:e.innerText??e.textContent??""}setText(e,t){if(e instanceof HTMLTextAreaElement){const n=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value")?.set;return n?.call(e,t),void e.dispatchEvent(new Event("input",{bubbles:!0}))}e.focus(),document.execCommand("selectAll",!1),document.execCommand("insertText",!1,t)}}class i{constructor(){this.siteName="Claude"}getInputElement(){return document.querySelector('[data-testid="composer-parent"] .ProseMirror')??document.querySelector('div.ProseMirror[contenteditable="true"]')}getSubmitButton(){return document.querySelector('button[aria-label*="send" i]')??document.querySelector('[data-testid="send-button"]')}getText(e){return e.innerText??e.textContent??""}setText(e,t){e.focus(),document.execCommand("selectAll",!1),document.execCommand("insertText",!1,t)}}class l{constructor(){this.siteName="Gemini"}getInputElement(){return document.querySelector("rich-textarea .ql-editor")??document.querySelector('[contenteditable="true"][aria-label*="prompt" i]')}getSubmitButton(){return document.querySelector('button[aria-label*="send" i]')??document.querySelector("button.send-button")}getText(e){return e.innerText??e.textContent??""}setText(e,t){e.focus(),document.execCommand("selectAll",!1),document.execCommand("insertText",!1,t)}}const d={block:{bg:"#1a0a0a",border:"#7f1d1d",title:"#f87171"},warn:{bg:"#1a1500",border:"#78350f",title:"#fbbf24"},mask:{bg:"#0a0f1a",border:"#1e3a5f",title:"#60a5fa"},info:{bg:"#0f1a0f",border:"#14532d",title:"#4ade80"}};let p=null;function u(){if(p)return{host:p.host,shadow:p};const e=document.createElement("div");return e.id="promptguard-ui",e.style.cssText="position:fixed;top:16px;right:16px;z-index:2147483647;pointer-events:none;",document.body.appendChild(e),p=e.attachShadow({mode:"closed"}),{host:e,shadow:p}}function m(e,t,n=[],o=5e3){const{shadow:r}=u(),a=d[e],s=document.createElement("div");s.style.cssText=`\n    pointer-events: auto;\n    margin-bottom: 8px;\n    padding: 12px 16px;\n    border-radius: 12px;\n    border: 1px solid ${a.border};\n    background: ${a.bg};\n    min-width: 280px;\n    max-width: 360px;\n    font-family: system-ui, sans-serif;\n    box-shadow: 0 8px 32px rgba(0,0,0,0.5);\n    animation: pgSlideIn 0.25s ease;\n  `;const c=document.createElement("style");c.textContent="\n    @keyframes pgSlideIn { from { opacity:0; transform:translateX(24px); } to { opacity:1; transform:translateX(0); } }\n  ",r.appendChild(c);const i=document.createElement("div");i.style.cssText=`color:${a.title};font-size:13px;font-weight:600;margin-bottom:${n.length?"6px":"0"};`,i.textContent=t,s.appendChild(i);for(const e of n){const t=document.createElement("div");t.style.cssText="color:#9ca3af;font-size:11px;margin-top:2px;",t.textContent=e,s.appendChild(t)}r.appendChild(s),setTimeout(()=>{s.style.transition="opacity 0.3s",s.style.opacity="0",setTimeout(()=>s.remove(),300)},o)}let g=null,y=null,f=!1;function b(s,c){if(!g?.enabled)return;const i=y.getText(c).trim();if(!i)return;const{sanitizedPrompt:l,detections:p}=function(e){let n=e;const o=[];for(const e of t){const t=new RegExp(e.pattern.source,e.pattern.flags),r=n.match(t);r&&r.length>0&&(o.push({type:e.type,count:r.length,severity:e.severity}),n=n.replace(new RegExp(e.pattern.source,e.pattern.flags),e.replacement))}return{sanitizedPrompt:n,detections:o}}(i),{sanitizedText:b}=function(t,n){let o=t;const r={},a=e.filter(e=>n.includes(e.type));for(const e of a){const t=new RegExp(e.pattern.source,e.pattern.flags),n=o.match(t);n&&n.length>0&&(r[e.type]=(r[e.type]??0)+n.length,o=o.replace(new RegExp(e.pattern.source,e.pattern.flags),e.replacement))}return{sanitizedText:o,redactions:Object.entries(r).map(([e,t])=>({type:e,count:t}))}}(l,g.filters),h=p.length>0?function(e){const t=e.reduce((e,t)=>e+n[t.type]*t.count,0),r=Math.min(100,t);return{score:r,level:o(r),detections:e}}(p):null,x=function(e,t){const n=[];for(const o of e)o.enabled&&a(o,t)&&n.push({policyId:o.id,policyName:o.name,action:o.action});return 0===n.length?{action:"allow",matches:[]}:{action:n.reduce((e,t)=>r[t.action]>r[e]?t.action:e,"allow"),matches:n}}(g.policies,{detections:p,riskScore:h,messageText:i}),E="critical"===h?.level,T="block"===x.action;if(E||T){s.stopImmediatePropagation(),s.preventDefault();const e=[];if(E){e.push(`Risk Score: ${h.score}/100 (Critical)`);for(const t of p)e.push(`${t.count}Ã— ${t.type.replace(/_/g," ")}`)}if(T)for(const t of x.matches.filter(e=>"block"===e.action))e.push(`Policy: "${t.policyName}"`);return void function(e,t){const{shadow:n}=u(),o=d.block,r=document.createElement("div");r.style.cssText=`\n    pointer-events: auto;\n    margin-bottom: 8px;\n    padding: 16px;\n    border-radius: 12px;\n    border: 1px solid ${o.border};\n    background: ${o.bg};\n    min-width: 280px;\n    max-width: 380px;\n    font-family: system-ui, sans-serif;\n    box-shadow: 0 8px 32px rgba(0,0,0,0.6);\n  `;const a=document.createElement("div");a.style.cssText="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;";const s=document.createElement("div");s.style.cssText=`color:${o.title};font-size:13px;font-weight:700;`,s.textContent="ðŸ›¡ PromptGuard: Message Blocked";const c=document.createElement("button");c.style.cssText=`\n    background:none;border:1px solid ${o.border};border-radius:6px;\n    color:#9ca3af;font-size:11px;padding:2px 8px;cursor:pointer;\n  `,c.textContent="Dismiss",c.onclick=()=>r.remove(),a.appendChild(s),a.appendChild(c),r.appendChild(a);for(const e of t){const t=document.createElement("div");t.style.cssText="color:#f87171;font-size:11px;margin-top:4px;",t.textContent=`â€¢ ${e}`,r.appendChild(t)}n.appendChild(r)}(0,e)}const A=b!==i;if(A||"mask"===x.action){s.stopImmediatePropagation(),s.preventDefault();let e=A?b:i;if("mask"===x.action)for(const t of x.matches.filter(e=>"mask"===e.action)){const n=g.policies.find(e=>e.id===t.policyId);if("keyword"===n?.condition.type&&n.condition.keyword){const t=n.condition.keyword.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");e=e.replace(new RegExp(t,"gi"),"[REDACTED_BY_POLICY]")}}y.setText(c,e);const t=[];for(const e of p)t.push(`${e.count}Ã— ${e.type.replace(/_/g," ")} removed`);return"mask"===x.action&&x.matches.length>0&&t.push(`Policy: "${x.matches[0].policyName}"`),m("mask","ðŸ”µ PromptGuard: Prompt sanitized",t),f=!0,void setTimeout(()=>{y.getSubmitButton()?.click(),setTimeout(()=>{f=!1},200)},60)}if("warn"===x.action||"high"===h?.level){const e=[];for(const t of x.matches)e.push(`Policy: "${t.policyName}"`);!e.length&&h&&e.push(`Risk Score: ${h.score}/100`),m("warn","âš ï¸ PromptGuard: Sensitive data detected",e,8e3)}}chrome.storage.onChanged.addListener(e=>{g&&(e.enabled&&(g.enabled=e.enabled.newValue),e.filters&&(g.filters=e.filters.newValue),e.policies&&(g.policies=e.policies.newValue))}),async function(){y=function(){const e=location.hostname;return e.includes("chatgpt.com")?new c:e.includes("claude.ai")?new i:e.includes("gemini.google.com")?new l:null}(),y&&(await async function(){g=await new Promise(e=>{chrome.storage.local.get(s,t=>{e(t)})})}(),document.addEventListener("keydown",e=>{const t=e;if("Enter"!==t.key||t.shiftKey||f)return;const n=y.getInputElement();n&&b(e,n)},{capture:!0}),document.addEventListener("click",e=>{if(f)return;const t=y.getInputElement();t&&b(e,t)},{capture:!0}))}()})();